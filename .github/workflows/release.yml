name: release-peek

on:
  push:
    tags:
      - "v*" # Trigger when version tag like v1.0.0 is pushed

env:
  CARGO_TERM_COLOR: always
  AUR_REPO: "peek"
  AUR_EMAIL: "emuthiani26@gmail.com"
  AUR_USER: "lyznne"

jobs:
  build:
    name: Build and Upload Release Assets
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package binary
        shell: bash
        run: |
          mkdir -p dist
          cd target/${{ matrix.target }}/release
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            zip -r ../../../dist/peek-${{ matrix.target }}.zip peek.exe
          else
            tar czf ../../../dist/peek-${{ matrix.target }}.tar.gz peek
          fi
          cd ../../../

      - name: Upload binaries to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  aur:
    name: Update and Push AUR Package
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Arch packaging tools
        run: sudo apt-get update && sudo apt-get install -y base-devel fakeroot git

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PEEK_ACCESS }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Prepare AUR repo
        run: |
          git clone ssh://aur@aur.archlinux.org/${AUR_REPO}.git aur-repo
          cp PKGBUILD aur-repo/
          cd aur-repo

          VERSION="${GITHUB_REF_NAME#v}"
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          makepkg --printsrcinfo > .SRCINFO

      - name: Push updates to AUR
        run: |
          cd aur-repo
          git config user.name "${AUR_USER}"
          git config user.email "${AUR_EMAIL}"
          git add PKGBUILD .SRCINFO
          git commit -m "Release ${GITHUB_REF_NAME}" || echo "No changes to commit"
          git push
        env:
          GIT_SSH_COMMAND: "ssh -i ~/.ssh/aur -o StrictHostKeyChecking=no"

      - name: Upload PKGBUILD to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: aur-repo/PKGBUILD
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
